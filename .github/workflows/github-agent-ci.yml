# GitHub PR Manager CI/CD Pipeline
name: GitHub Agent CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'agents/github-pr-manager/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'agents/github-pr-manager/**'
      - '.github/workflows/**'

env:
  NODE_VERSION: '18'
  WORKING_DIR: 'agents/github-pr-manager'

jobs:
  syntax-check:
    name: Syntax & Structure Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Syntax check - index.js
        working-directory: ${{ env.WORKING_DIR }}
        run: node -c src/index.js

      - name: Syntax check - ai-service.js
        working-directory: ${{ env.WORKING_DIR }}
        run: node -c src/ai-service.js

      - name: Validate brace balance
        working-directory: ${{ env.WORKING_DIR }}/src
        shell: bash
        run: |
          echo "Checking brace balance in index.js..."
          open_braces=$(grep -o '{' index.js | wc -l)
          close_braces=$(grep -o '}' index.js | wc -l)
          open_parens=$(grep -o '(' index.js | wc -l)
          close_parens=$(grep -o ')' index.js | wc -l)
          
          echo "Braces: $open_braces open, $close_braces close"
          echo "Parens: $open_parens open, $close_parens close"
          
          if [ "$open_braces" -ne "$close_braces" ]; then
            echo "‚ùå Unbalanced braces detected!"
            exit 1
          fi
          
          if [ "$open_parens" -ne "$close_parens" ]; then
            echo "‚ùå Unbalanced parentheses detected!"
            exit 1
          fi
          
          echo "‚úÖ All braces and parentheses balanced"

      - name: Check for duplicate functions
        working-directory: ${{ env.WORKING_DIR }}/src
        shell: bash
        run: |
          echo "Checking for duplicate function declarations..."
          
          # Check for duplicate queueWebhookForProcessing
          queue_funcs=$(grep -c "function queueWebhookForProcessing\|queueWebhookForProcessing.*=" index.js || echo "0")
          if [ "$queue_funcs" -gt 1 ]; then
            echo "‚ùå Duplicate queueWebhookForProcessing function found!"
            grep -n "queueWebhookForProcessing" index.js
            exit 1
          fi
          
          # Check for any duplicated function names
          duplicate_funcs=$(grep -E "(function|const|let|var)\s+\w+.*=" index.js | cut -d' ' -f2 | cut -d'(' -f1 | sort | uniq -d)
          if [ -n "$duplicate_funcs" ]; then
            echo "‚ùå Duplicate function declarations found:"
            echo "$duplicate_funcs"
            exit 1
          fi
          
          echo "‚úÖ No duplicate functions detected"

  lint-and-type-check:
    name: Linting & Type Checking
    runs-on: ubuntu-latest
    needs: syntax-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Run ESLint
        working-directory: ${{ env.WORKING_DIR }}
        run: npx eslint src --ext .js,.ts --max-warnings=0 --format=github

      - name: TypeScript type check
        working-directory: ${{ env.WORKING_DIR }}
        run: npx tsc --noEmit

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: syntax-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Run unit tests
        working-directory: ${{ env.WORKING_DIR }}
        run: npm test

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [syntax-check, lint-and-type-check, unit-tests]
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: github_agent_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Start GitHub PR Manager
        working-directory: ${{ env.WORKING_DIR }}
        env:
          NODE_ENV: test
          PORT: 3001
          GITHUB_REPOSITORY: test/test-repo
          GITHUB_TOKEN: fake-token
          WEBHOOK_SECRET: test-secret
          ENABLE_AI_ANALYSIS: false
          REDIS_URL: redis://localhost:6379
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/github_agent_test
        run: |
          node src/index.js &
          echo $! > server.pid
          
          # Wait for server to start
          for i in {1..30}; do
            if curl -f http://localhost:3001/health > /dev/null 2>&1; then
              echo "Server started successfully"
              break
            fi
            echo "Waiting for server to start... ($i/30)"
            sleep 2
          done

      - name: Run webhook integration tests
        working-directory: ${{ env.WORKING_DIR }}
        env:
          TEST_BASE_URL: http://localhost:3001
          WEBHOOK_SECRET: test-secret
        run: node webhook-integration-test.js

      - name: Validate Prometheus metrics
        run: |
          echo "üîç Checking metrics endpoint..."
          curl -f http://localhost:3001/metrics
          
          echo "üìà Verifying webhook metrics are available..."
          curl -s http://localhost:3001/metrics | grep -E "(github_webhooks_total|github_webhook_queue_length|github_webhook_processing_duration_seconds)" || {
            echo "‚ùå Required Prometheus metrics not found"
            exit 1
          }
          
          echo "‚úÖ All Prometheus metrics validated"

      - name: Test PowerShell webhook compatibility
        run: |
          echo "üîß Testing PowerShell-compatible webhook signature..."
          
          # Generate signature using openssl (simulates PowerShell HMAC)
          payload='{"test":"powershell_ci_test","timestamp":"'$(date +%s)'"}'
          secret="test-secret"
          signature="sha256="$(echo -n "$payload" | openssl dgst -sha256 -hmac "$secret" | cut -d' ' -f2)
          
          echo "üì° Sending webhook with PowerShell-compatible signature..."
          response=$(curl -s -w "%{http_code}" -o /dev/null \
            -X POST http://localhost:3001/webhook \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: ping" \
            -H "X-GitHub-Delivery: $(uuidgen)" \
            -H "X-Hub-Signature-256: $signature" \
            --data "$payload")
          
          if [ "$response" = "202" ]; then
            echo "‚úÖ PowerShell compatibility verified (HTTP $response)"
          else
            echo "‚ùå PowerShell compatibility failed (HTTP $response)"
            exit 1
          fi

      - name: Stop server
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [syntax-check, lint-and-type-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          docker build -t github-pr-manager:test .

      - name: Test Docker container syntax
        run: |
          docker run --rm github-pr-manager:test node -c src/index.js

      - name: Test Docker container startup (dry run)
        run: |
          docker run --rm -e GITHUB_REPOSITORY=test/test \
            -e GITHUB_TOKEN=fake-token \
            -e WEBHOOK_SECRET=test-secret \
            -e ENABLE_AI_ANALYSIS=false \
            github-pr-manager:test timeout 10 node src/index.js || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: syntax-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: Run npm audit
        working-directory: ${{ env.WORKING_DIR }}
        run: npm audit --audit-level=moderate

      - name: Check for secrets in code
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Checking for potential secrets..."
          
          # Check for hardcoded tokens, passwords, etc.
          if grep -r -E "(password|token|secret|key)\s*[:=]\s*['\"][^'\"]{8,}" src/ || true; then
            echo "‚ö†Ô∏è  Potential hardcoded secrets found - please review"
          fi
          
          # Check for TODO/FIXME that might indicate security issues
          security_todos=$(grep -r -i "TODO.*security\|FIXME.*security\|XXX.*security" src/ || echo "")
          if [ -n "$security_todos" ]; then
            echo "‚ö†Ô∏è  Security-related TODOs found:"
            echo "$security_todos"
          fi

  environment-check:
    name: Environment Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required environment variables in docker-compose
        working-directory: agents
        run: |
          echo "Checking docker-compose files for required environment variables..."
          
          required_vars=("GITHUB_REPOSITORY" "GITHUB_TOKEN" "WEBHOOK_SECRET")
          
          for compose_file in docker-compose*.yml; do
            echo "Checking $compose_file..."
            
            for var in "${required_vars[@]}"; do
              if ! grep -q "\$.*$var" "$compose_file"; then
                echo "‚ö†Ô∏è  $var not found in $compose_file"
              else
                echo "‚úÖ $var found in $compose_file"
              fi
            done
          done

      - name: Validate .env.example completeness
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "Checking .env.example for completeness..."
          
          required_vars=("GITHUB_TOKEN" "GITHUB_REPOSITORY" "WEBHOOK_SECRET" "PORT" "NODE_ENV")
          missing_vars=()
          
          for var in "${required_vars[@]}"; do
            if ! grep -q "^$var=" .env.example; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "‚ùå Missing variables in .env.example:"
            printf '%s\n' "${missing_vars[@]}"
            exit 1
          fi
          
          echo "‚úÖ All required variables present in .env.example"

  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    needs: [integration-tests, docker-build, security-scan, environment-check]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deployment readiness report
        run: |
          echo "üöÄ Deployment Readiness Report"
          echo "=============================="
          echo "‚úÖ Syntax validation passed"
          echo "‚úÖ Linting and type checking passed"
          echo "‚úÖ Unit tests passed"
          echo "‚úÖ Integration tests passed"
          echo "‚úÖ Docker build successful"
          echo "‚úÖ Security scan completed"
          echo "‚úÖ Environment validation passed"
          echo ""
          echo "üì¶ Ready for deployment to production"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üöÄ CI Pipeline Results

              ‚úÖ **All checks passed!** This PR is ready for deployment.

              **Validation Summary:**
              - ‚úÖ Syntax validation
              - ‚úÖ Linting & type checking  
              - ‚úÖ Unit tests
              - ‚úÖ Integration tests
              - ‚úÖ Docker build
              - ‚úÖ Security scan
              - ‚úÖ Environment validation

              **Commit:** \`${{ github.sha }}\`
              **Build:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })